<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link type="text/css" rel="stylesheet" href="./css/main.css">
    <link type="text/css" rel="stylesheet" href="./css/loading.css">
</head>

<body>

    <script async src="./js/es-module-shims.js"></script>

    <script type="importmap">
        {
            "imports": {
                "three": "https://threejs.org/build/three.module.js",
                "lil-gui": "https://threejs.org/examples/jsm/libs/lil-gui.module.min.js",
                "postprocessing": "./js/postprocessing.esm.js"
            }
        }
    </script>

    <script type="module">

        import * as THREE from "three";
        import { Application } from "./js/app.module.js";

        import { EditorPlugin } from "./js/plugins/editor.js";

        import { SurfaceMaterial } from "./js/SurfaceMaterial.js";

        import { LoadingScreen } from "./js/loading-screen.js";

        let loadingScreen = new LoadingScreen();

        let app = new Application( document.body, {
            antialias: true,
            clearColor: 0xf5a356,
        } );

        app.camera.position.set( 3.4, 2, -2 );

        let editor = new EditorPlugin( app );

        let light = new THREE.DirectionalLight( 'white' );
        light.position.set( -1, 5, -1 );
        const mapSize = 1024;
        light.shadow.mapSize.width = mapSize;
        light.shadow.mapSize.height = mapSize;
        light.castShadow = true;
        app.root.add( light );

        app.root.add( new THREE.AmbientLight( 'white', 0.15 ) );

        // ==================================

        let mesh;

        let Shader = {
            properties: {
                '_Color:v3': new THREE.Color( 0xd8d8d8 ),
                '_ColorDim:v3': new THREE.Color( 0xd8d8d8 ),
                '_SelfShadingSize:t': 0.0,
                '_ShadowEdgeSize:t': 0.05,
                '_Flatness:t': 1.0,
                // Cel
                '_ColorDimExtra:v3': new THREE.Color( 0xd8d8d8 ),
                '_SelfShadingSizeExtra:t': 0.0,
                '_ShadowEdgeSizeExtra:t': 0.0,
                '_FlatnessExtra:t': 1.0,
                // Specular
                '_FlatSpecularSize:t': 0.1,
                '_FlatSpecularEdgeSmoothness:t': 0.0,
                '_FlatSpecularColor:v3': new THREE.Color( 0xd8d8d8 ),
                // Rim
                '_FlatRimColor:v3': new THREE.Color( 0xd8d8d8 ),
                '_FlatRimLightAlign:t': 0.0,
                '_FlatRimSize:t': 0.174,
                '_FlatRimEdgeSmoothness:t': 0.279,
                // Gradient
                '_ColorGradient:v3': new THREE.Color( 0xd8d8d8 ),
                '_GradientCenterX:t': 0.0,
                '_GradientCenterY:t': 0.0,
                '_GradientSize:t': 10.0,
                '_GradientAngle:t': 0.0,

            },
            defines: {
                DR_CEL_EXTRA_ON: false,
                DR_SPECULAR_ON: false,
                DR_RIM_ON: false,
                DR_GRADIENT_ON: false,
            },
            lightModel: /* glsl */``,
            surfaceFunc: /* glsl */`

float NdotLTransition(vec3 normal, vec3 lightDir, float selfShadingSize, float shadowEdgeSize, float flatness) {

    // normal and lightDir are assumed to be normalized.
    float NdotL = dot( normal, lightDir );
    float angleDiff = saturate( ( NdotL * 0.5 + 0.5 ) - selfShadingSize );
    float angleDiffTransition = smoothstep( 0.0, shadowEdgeSize, angleDiff ); 
    return lerp( angleDiff, angleDiffTransition, flatness );

}

float NdotLTransitionPrimary( vec3 normal, vec3 lightDir ) {

    return NdotLTransition( normal, lightDir, _SelfShadingSize, _ShadowEdgeSize, _Flatness );

}

float NdotLTransitionExtra( vec3 normal, vec3 lightDir ) { 

    return NdotLTransition( normal, lightDir, _SelfShadingSizeExtra, _ShadowEdgeSizeExtra, _FlatnessExtra );

}

void surface( Input IN, inout SurfaceOutput o ) {

    vec3 lightDir = IN.lightDir;
    vec3 viewDir = IN.viewDir;
    vec3 Normal = IN.Normal;
    vec3 worldPos = IN.worldPos;

    vec3 c = _Color;

    float NdotLTPrimary = NdotLTransitionPrimary( Normal, lightDir );
    c = lerp( _ColorDim, _Color, NdotLTPrimary );

    // Cel Extra
#if defined( DR_CEL_EXTRA_ON )
    float NdotLTExtra = NdotLTransitionExtra( Normal, lightDir );
    c = lerp( _ColorDimExtra, c, NdotLTExtra );
#endif

    // Gradient
#if defined(DR_GRADIENT_ON)
    float angleRadians = _GradientAngle / 180.0 * 3.14159265359;
    float posGradRotated = (worldPos.x - _GradientCenterX) * sin(angleRadians) + (worldPos.y - _GradientCenterY) * cos(angleRadians);
    float gradientTop = _GradientCenterY + _GradientSize * 0.5;
    float gradientFactor = saturate((gradientTop - posGradRotated) / _GradientSize);
    c = lerp(c, _ColorGradient, gradientFactor);
#endif

    // Rim
#if defined(DR_RIM_ON)
    float rim = 1.0 - dot( viewDir, Normal );
    float NdotL = dot( Normal, lightDir );
    float rimLightAlign = _FlatRimLightAlign;
    float rimSize = _FlatRimSize;
    float rimSpread = 1.0 - rimSize - NdotL * rimLightAlign;
    float rimEdgeSmooth = _FlatRimEdgeSmoothness;
    float rimTransition = smoothstep( rimSpread - rimEdgeSmooth * 0.5, rimSpread + rimEdgeSmooth * 0.5, rim );
    c = lerp( c, _FlatRimColor, rimTransition );
#endif
    
    // Specular
#if defined(DR_SPECULAR_ON)
    vec3 halfVector = normalize( lightDir + viewDir );
    float NdotH = dot( Normal, halfVector ) * 0.5 + 0.5;
    float specularSize = _FlatSpecularSize;
    float specEdgeSmooth = _FlatSpecularEdgeSmoothness;
    float specular = saturate( pow( NdotH, 100.0 * ( 1.0 - specularSize ) * ( 1.0 - specularSize ) ) );
    float specularTransition = smoothstep( 0.5 - specEdgeSmooth * 0.1, 0.5 + specEdgeSmooth * 0.1, specular );
    c = lerp( c, _FlatSpecularColor, specularTransition );
#endif

    o.Albedo = c;

}
                `
        };

        let bodyMaterial = new SurfaceMaterial( Shader );
        bodyMaterial.defines.DR_CEL_EXTRA_ON = true;
        bodyMaterial.defines.DR_SPECULAR_ON = true;
        bodyMaterial.defines.DR_RIM_ON = true;
        bodyMaterial.setUniformsValue( {
            _Color: new THREE.Color( 0xE5B700 ),
            _ColorDim: new THREE.Color( 0xD9D9D9 ),
            _ColorDimExtra: new THREE.Color( 0xff4d00 ),
            _SelfShadingSizeExtra: 0.5,
            _ShadowEdgeSizeExtra: 0.13,
            _FlatSpecularColor: new THREE.Color( 0xffe764 ),
            _FlatRimColor: new THREE.Color( 0xffe764 ),
            _ColorGradient: new THREE.Color( 0xff6e00 ),
        } );

        let chromeMaterial = new SurfaceMaterial( Shader );
        chromeMaterial.setUniformsValue( {
            _Color: new THREE.Color( 0xC0C0C0 ),
            _ColorDim: new THREE.Color( 0xD9D9D9 ),
            _FlatSpecularColor: new THREE.Color( 0xdbdbdb ),
            // _FlatRimColor: new THREE.Color( 0x10605c ),
            // _ColorGradient: new THREE.Color( 0xdbdbdb ),
        } );

        let chrome2Material = new SurfaceMaterial( Shader );
        chrome2Material.setUniformsValue( {
            _Color: new THREE.Color( 0xcfcfcf ),
            _ColorDim: new THREE.Color( 0x0bdbd7 ),
            _SelfShadingSize: 0.5,
            // _ColorGradient: new THREE.Color( 0x315987 ),
        } );

        let hatchMaterial = new SurfaceMaterial( Shader );
        hatchMaterial.defines.DR_CEL_EXTRA_ON = true;
        hatchMaterial.defines.DR_SPECULAR_ON = true;
        hatchMaterial.defines.DR_RIM_ON = true;
        hatchMaterial.defines.DR_GRADIENT_ON = true;
        hatchMaterial.setUniformsValue( {
            _Color: new THREE.Color( 0x222222 ),
            _ColorDim: new THREE.Color( 0xD9D9D9 ),
            _FlatSpecularColor: new THREE.Color( 0x464545 ),
            _FlatRimColor: new THREE.Color( 0x374f4e ),
            _ColorGradient: new THREE.Color( 0x903733 ),
        } )

        let platesMaterial = new SurfaceMaterial( Shader );
        platesMaterial.setUniformsValue( {
            _Color: new THREE.Color( 0x1e1515 ),
            _ColorDim: new THREE.Color( 0xD9D9D9 ),
            _FlatSpecularColor: new THREE.Color( 0x595959 ),
            _FlatRimColor: new THREE.Color( 0x10605c ),
            // _ColorGradient: new THREE.Color( 0x000000 ),
        } );

        let tyresMaterial = new SurfaceMaterial( Shader );
        tyresMaterial.setUniformsValue( {
            _Color: new THREE.Color( 0x000000 ),
            _ColorDim: new THREE.Color( 0x000000 ),
            _FlatSpecularColor: new THREE.Color( 0x000000 ),
            _FlatRimColor: new THREE.Color( 0x000000 ),
            _ColorGradient: new THREE.Color( 0x000000 ),
        } );

        let light2Material = new SurfaceMaterial( Shader );
        light2Material.setUniformsValue( {
            _Color: new THREE.Color( 0xf1a90a ),
            _ColorDim: new THREE.Color( 0xdce531 ),
            _SelfShadingSize: 0.5
        } )

        let surfFolder;

        function initMaterialGUI( material ) {

            if ( surfFolder ) {

                surfFolder.destroy();
                surfFolder = null;

            }

            surfFolder = app.debug.ui.addFolder( 'Surface Material' );
            surfFolder.addColor( material.uniforms._Color, 'value' ).name( 'Color' );

            let celFolder = surfFolder.addFolder( 'Cel Shading Mode' )
            celFolder.addColor( material.uniforms._ColorDim, 'value' ).name( 'Color Shaded' );
            celFolder.add( material.uniforms._SelfShadingSize, 'value', 0, 1, 0.001 ).name( 'Self Shading Size' );
            celFolder.add( material.uniforms._ShadowEdgeSize, 'value', 0, 1, 0.001 ).name( 'Shadow Edge Size' );
            celFolder.add( material.uniforms._Flatness, 'value', 0, 1, 0.001 ).name( 'Localized Shading' );

            let extraCelFolder;
            surfFolder.add( material.defines, 'DR_CEL_EXTRA_ON' ).name( 'Enable Extra Cel Layer' ).onChange( ( value ) => {
                material.defines.DR_CEL_EXTRA_ON = value;
                material.needsUpdate = true;
                ( !value && extraCelFolder.hide() ) || ( value && extraCelFolder.show() );
            } )
            extraCelFolder = surfFolder.addFolder( 'Extra Cel Layer' );
            extraCelFolder.addColor( material.uniforms._ColorDimExtra, 'value' ).name( 'Color Shaded' );
            extraCelFolder.add( material.uniforms._SelfShadingSizeExtra, 'value', 0, 1, 0.001 ).name( 'Self Shading Size' );
            extraCelFolder.add( material.uniforms._ShadowEdgeSizeExtra, 'value', 0, 1, 0.001 ).name( 'Shadow Edge Size' );
            extraCelFolder.add( material.uniforms._FlatnessExtra, 'value', 0, 1, 0.001 ).name( 'Localized Shading' );
            extraCelFolder.hide();
            if ( material.defines.DR_CEL_EXTRA_ON ) {
                extraCelFolder.show();
            }

            let specularFolder;
            surfFolder.add( material.defines, 'DR_SPECULAR_ON' ).name( 'Enable Specular' ).onChange( ( value ) => {
                material.defines.DR_SPECULAR_ON = value;
                material.needsUpdate = true;
                ( !value && specularFolder.hide() ) || ( value && specularFolder.show() );
            } )
            specularFolder = surfFolder.addFolder( 'Specular' );
            specularFolder.addColor( material.uniforms._FlatSpecularColor, 'value' ).name( 'Specular Color' );
            specularFolder.add( material.uniforms._FlatSpecularSize, 'value', 0, 1, 0.001 ).name( 'Specular Size' );
            specularFolder.add( material.uniforms._FlatSpecularEdgeSmoothness, 'value', 0, 1, 0.001 ).name( 'Specular Edge Smoothness' );
            specularFolder.hide();
            if ( material.defines.DR_SPECULAR_ON ) {
                specularFolder.show();
            }

            let rimFolder;
            surfFolder.add( material.defines, 'DR_RIM_ON' ).name( 'Enable Rim' ).onChange( ( value ) => {
                material.defines.DR_RIM_ON = value;
                material.needsUpdate = true;
                ( !value && rimFolder.hide() ) || ( value && rimFolder.show() );
            } )
            rimFolder = surfFolder.addFolder( 'Rim' );
            rimFolder.addColor( material.uniforms._FlatRimColor, 'value' ).name( 'Rim Color' );
            rimFolder.add( material.uniforms._FlatRimLightAlign, 'value', 0, 1, 0.001 ).name( 'Light Align' );
            rimFolder.add( material.uniforms._FlatRimSize, 'value', 0, 1, 0.001 ).name( 'Rim Size' );
            rimFolder.add( material.uniforms._FlatRimEdgeSmoothness, 'value', 0, 1, 0.001 ).name( 'Rim Edge Smoothness' );
            rimFolder.hide();
            if ( material.defines.DR_RIM_ON ) {
                rimFolder.show();
            }

            let gradientFactor;
            surfFolder.add( material.defines, 'DR_GRADIENT_ON' ).name( 'Enable Height Gradient' ).onChange( ( value ) => {
                material.defines.DR_GRADIENT_ON = value;
                material.needsUpdate = true;
                ( !value && gradientFactor.hide() ) || ( value && gradientFactor.show() );
            } )
            gradientFactor = surfFolder.addFolder( 'Height Gradient' );
            gradientFactor.addColor( material.uniforms._ColorGradient, 'value' ).name( 'Gradient Color' );
            gradientFactor.add( material.uniforms._GradientCenterX, 'value' ).name( 'Center X' );
            gradientFactor.add( material.uniforms._GradientCenterY, 'value' ).name( 'Center Y' );
            gradientFactor.add( material.uniforms._GradientSize, 'value' ).name( 'Size' );
            gradientFactor.add( material.uniforms._GradientAngle, 'value', 0, 360, 1 ).name( 'Gradient Angle' );
            gradientFactor.hide();
            if ( material.defines.DR_GRADIENT_ON ) {
                gradientFactor.show();
            }

            // surfFolder.close()

        }

        // initMaterialGUI( bodyMaterial );

        editor.on( 'select', object => {

            if ( object && object.isMesh ) {

                if ( object.material.isSurfaceMaterial ) {

                    initMaterialGUI( object.material );

                } else {

                    surfFolder && surfFolder.destroy();
                    surfFolder = null;

                }

            } else {

                surfFolder && surfFolder.destroy();
                surfFolder = null;

            }

        } )

        mesh = new THREE.Mesh(
            new THREE.BoxGeometry(),
            bodyMaterial
        );
        mesh.position.y += 0.5;
        // app.root.add( mesh );

        // ==================================

        const geometry = new THREE.PlaneGeometry( 5, 5 );
        geometry.rotateX( - Math.PI / 2 );

        const material = new THREE.ShadowMaterial();
        material.opacity = 0.2;

        mesh = new THREE.Mesh( geometry, material );
        mesh.receiveShadow = true;
        app.root.add( mesh );

        // ==================================

        let assets = [
            {
                name: 'Car',
                data: {},
                items: [
                    { name: 'Car', url: './asset/fbx/Car.fbx' },
                ]
            }
        ];

        app.assetManager.once( 'end', () => {

            loadingScreen.end();

            let assets = app.assetManager.assets;

            let Car = assets.Car;
            Car.rotateX( - Math.PI / 2 );
            editor.group.add( Car );

            Car.traverse( child => {
                if ( child.isMesh )
                    child.castShadow = true;
            } )

            Car.getObjectByName( 'Car_Body' ).material = bodyMaterial;

            Car.getObjectByName( 'Car_WindowsFrames' ).material =
                Car.getObjectByName( 'Car_Mirrors' ).material =
                Car.getObjectByName( 'Car_LightsRims' ).material =
                Car.getObjectByName( 'Car_Bumpers' ).material =
                Car.getObjectByName( 'Car_Logo_Front' ).material =
                Car.getObjectByName( 'Car_RearDoorHandle' ).material =
                Car.getObjectByName( 'Car_Wipers' ).material =
                Car.getObjectByName( 'Car_Maldings' ).material =
                Car.getObjectByName( 'Car_DoorHandles' ).material =
                Car.getObjectByName( 'Car_Plate_Front_Rim' ).material =
                Car.getObjectByName( 'Car_Plate_Rear_Rim' ).material =
                Car.getObjectByName( 'Car_Wheel_Front_Left_Rim' ).material =
                Car.getObjectByName( 'Car_Wheel_Front_Right_Rim' ).material =
                Car.getObjectByName( 'Car_Wheel_Rear_Left_Rim' ).material =
                Car.getObjectByName( 'Car_Wheel_Rear_Right_Rim' ).material = chromeMaterial;

            Car.getObjectByName( 'Car_Lights1' ).material = chromeMaterial;

            Car.getObjectByName( 'Car_LightsSmall' ).material =
                Car.getObjectByName( 'Car_Lights2' ).material = light2Material;

            Car.getObjectByName( 'Car_Windows' ).material = platesMaterial;

            Car.getObjectByName( 'Car_Hatch' ).material = hatchMaterial;

            Car.getObjectByName( 'Car_Pipe' ).material =
                Car.getObjectByName( 'Car_Plate_Front' ).material =
                Car.getObjectByName( 'Car_Plate_Rear' ).material = platesMaterial;

            Car.getObjectByName( 'Car_Bottom' ).material =
                Car.getObjectByName( 'Car_Wheel_Front_Left_Tyre' ).material =
                Car.getObjectByName( 'Car_Wheel_Front_Right_Tyre' ).material =
                Car.getObjectByName( 'Car_Wheel_Rear_Left_Tyre' ).material =
                Car.getObjectByName( 'Car_Wheel_Rear_Right_Tyre' ).material = tyresMaterial;

            Car.getObjectByName( 'Car_Wheel_Front_Left_Cap1' ).material =
                Car.getObjectByName( 'Car_Wheel_Front_Right_Cap1' ).material =
                Car.getObjectByName( 'Car_Wheel_Rear_Left_Cap1' ).material =
                Car.getObjectByName( 'Car_Wheel_Rear_Right_Cap1' ).material = chrome2Material;

        } );
        app.assetManager.load( assets );

        // ==================================

        app.start();

    </script>

</body>

</html>